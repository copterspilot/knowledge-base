Схема хранения и ротации секретов для вашего стека (.NET Aspire, HashiCorp Vault, Keycloak, PostgreSQL):

```plantuml
@startuml
' Стили
skinparam rectangle {
    roundCorner 10
}
skinparam component {
    roundCorner 10
}
skinparam note {
    borderColor #cccccc
    backgroundColor #ffffcc
}

title Схема хранения и ротации секретов

' Kubernetes/Orchestration Environment
package "Kubernetes Cluster (Aspire)" {
    rectangle "Aspire App Host" as aspire_host #e3f2fd {
        rectangle "Frontend App Pod" as frontend_pod #c8e6c9 {
            rectangle "Frontend Container" as frontend_container #a5d6a7
        }
        rectangle "Backend API Pod" as backend_pod #e8f5e8 {
            rectangle "Backend Container" as backend_container #c5e1a5
            rectangle "Vault Agent Sidecar" as vault_agent #f3e5f5
        }
    }
    
    rectangle "HashiCorp Vault Pod" as vault_pod #fff3e0 {
        rectangle "Vault Server" as vault_server #ffe0b2
        rectangle "Vault Storage Backend" as vault_storage_int #ffcc80
    }
    
    rectangle "Keycloak Pod" as keycloak_pod #f3e5f5 {
        rectangle "Keycloak Container" as keycloak_container #e1bee7
    }
    
    rectangle "PostgreSQL Pod" as postgresql_pod #e0f2f1 {
        rectangle "PostgreSQL Container" as postgresql_container #b2dfdb
    }
}

' Внешние системы для секретов
rectangle "Внешние сервисы" as external_services #fce4ec {
    rectangle "Yandex Cloud\n(внешние API)" as yandex_cloud #f8bbd0
}

' Vault Storage Backend (внешний)
rectangle "Consul Cluster\n(External Storage)" as consul_backend #ffecb3

' Vault Secret Engines
rectangle "Vault Secret Engines" as secret_engines #fff3e0 {
    rectangle "KV Engine\n(secret/)" as kv_engine #ffe0b2
    rectangle "Database Engine\n(database/)" as db_engine #ffe0b2
    rectangle "PKI Engine\n(pki/)" as pki_engine #ffe0b2
}

' Типы секретов

' Связи между компонентами Vault
vault_server --> secret_engines : Управляет\nSecret Engines
vault_server --> vault_storage_int : Локальное\nхранилище
vault_storage_int --> consul_backend : Репликация\nданных

' Секреты
rectangle "Yandex Cloud API Key" as yandex_cloud_secret #ffebee
rectangle "PostgreSQL Config\n(root credentials)" as db_config_secret #ffebee
rectangle "Keycloak Secrets\n(admin password,\ndatabase creds)" as keycloak_secrets #ffebee
rectangle "Backend Secrets\n(DB creds, API keys)" as backend_secrets #e8f5e8

' Ротация секретов KV
vault_server -> vault_server : 1. Автоматическая ротация\n(по таймеру, каждые 5 мин)
vault_server -> kv_engine : 2. Генерация новых\nсекретов
kv_engine -> yandex_cloud_secret : 3. Обновление\nAPI ключа

' Ротация учетных записей БД
vault_server -> db_engine : 4. Ротация учетных\nзаписей БД
db_engine -> postgresql_container : 5. Создание\nновых ролей/пользователей
db_engine -> backend_pod : 6. Предоставление\nвременных учетных данных

' Vault Agent Sidecar
vault_agent --> vault_server : 7. Аутентификация\n(K8s SA) и получение\nсекретов
vault_agent --> backend_container : 8. Предоставление\nсекретов (файлы/\nпеременные среды)

' Keycloak Secrets Management
keycloak_container --> vault_server : 9. Получение секретов\n(при старте/обновлении)
vault_server --> keycloak_secrets : 10. Предоставление\nсекретов Keycloak
keycloak_container --> postgresql_container : 11. Подключение к БД\n(с учетными данными\nиз Vault)

' Backend API Secrets Usage
vault_agent --> backend_secrets : 13. Доступ к\nсекретам
backend_container --> vault_agent : 12. Использование\nсекретов из Vault Agent

' Backend API to External Services
backend_container --> yandex_cloud : 14. Вызов API\n(с ключом из Vault)

' Backend API to Database
backend_container --> postgresql_container : 15. Подключение к БД\n(с динамическими\nучетными данными)

' Связи для отображения хранения секретов
kv_engine --> yandex_cloud_secret : Хранит API ключ\nдля Yandex Cloud
kv_engine --> db_config_secret : Хранит начальную\nконфигурацию БД

@enduml
```

```
note bottom of vault_server
Vault автоматически
генерирует новые
значения для секретов
в KV engine по
расписанию.
end note

note bottom of db_engine
Database Engine
динамически создает
временные учетные
записи в PostgreSQL
с ограниченными
правами и сроком
действия.
end note

note right of vault_agent
Vault Agent Sidecar:
- Аутентифицируется в Vault
с помощью ServiceAccount
Pod'а Backend API.
- Получает актуальные
секреты.
- Предоставляет их
приложению через
файлы или сокет.
end note

note bottom of kv_engine
Хранение статических секретов:
- secret/myapp/yandex-cloud/api-key
- secret/myapp/config/sensitive-settings
end note

note bottom of db_engine
Динамические учетные записи БД:
- database/config/postgresql
- database/roles/myapp-backend
- database/creds/myapp-backend (генерируются)
end note

note bottom of pki_engine
Сертификаты:
- pki/roles/myapp-service
- pki/issue/myapp-service (генерируются)
end note


```


**Пояснение:**

Эта диаграмма иллюстрирует, как организовано **хранение и ротация секретов** в вашей системе:

1.  **HashiCorp Vault** является центральным хранилищем секретов. Он запущен в Kubernetes как Pod и использует внешний **Consul** в качестве надежного **Storage Backend** для хранения зашифрованных данных.
2.  **Secret Engines** в Vault:
    *   **KV Engine (`secret/`)**: Хранит **статические секреты**. В вашем случае это API-ключ для **Yandex Cloud** и, возможно, начальные учетные данные для **PostgreSQL** (которые Vault будет использовать для настройки динамической генерации).
    *   **Database Engine (`database/`)**: Управляет **динамическими учетными записями** для **PostgreSQL**. Vault имеет начальные привилегии (из KV) для создания новых ролей/пользователей в БД.
    *   **PKI Engine (`pki/`)**: (Может использоваться) для генерации внутренних TLS-сертификатов.
3.  **Ротация секретов**:
    *   **Статические секреты (KV)**: Vault настроен на **автоматическую ротацию** каждые 5 минут. Он генерирует новое значение (например, для API-ключа Yandex Cloud) и обновляет его в хранилище KV.
    *   **Динамические учетные записи (Database)**: Vault автоматически **ротирует учетные записи** для Backend API. При следующем запросе секрета Backend API получит **новые временные учетные данные** с ограниченным временем жизни (TTL). Vault сам управляет созданием и удалением этих учетных записей в PostgreSQL.
4.  **Распространение секретов**:
    *   **Для Backend API**: Используется **Vault Agent Sidecar**. Этот контейнер в Pod'е Backend API аутентифицируется в Vault с помощью **Kubernetes ServiceAccount** Pod'а. Он получает актуальные секреты (как статические из KV, так и динамические из Database Engine) и предоставляет их основному контейнеру приложения, например, через файлы в общей файловой системе или переменные среды. Это самый простой и безопасный способ для приложения получать секреты.
    *   **Для Keycloak**: При запуске или обновлении Keycloak получает свои секреты (например, пароль администратора, учетные данные для подключения к своей БД) напрямую от Vault (через API или init-container). Эти секреты могут ротироваться отдельно.
5.  **Использование секретов**:
    *   **Backend API** использует полученные от Vault Agent учетные данные для подключения к **PostgreSQL** (динамические) и для вызова **API Yandex Cloud** (статический ключ из KV).
    *   **Keycloak** использует свои секреты для своей внутренней работы и подключения к своей БД.

Эта схема показывает, как Vault централизованно управляет секретами, автоматически их ротирует и безопасно доставляет их потребителям, что соответствует современным практикам безопасности.