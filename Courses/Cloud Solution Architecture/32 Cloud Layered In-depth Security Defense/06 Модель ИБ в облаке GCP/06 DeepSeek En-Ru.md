# **Защита сети с использованием многоуровневой безопасности в Google Cloud: Полное руководство**

## **1. Микросегментация доступа к приложениям и сервисам**

### **IAM (API-доступ)**
**Цель:** Детальный контроль доступа к ресурсам GCP  
**Требования:**
- Принцип минимальных привилегий (PoLP)
- Использование предопределенных ролей вместо кастомных
- Включение организационных политик
- Обязательная MFA для административных аккаунтов

**Рекомендации:**
- Использование условий IAM для контекстно-зависимого доступа
- Имперсонация сервисных аккаунтов вместо обмена ключами
- Включение журналов аудита для критических ресурсов

**Пример нарушения:**  
*Случай (2021):* Разработчик назначил роль `roles/editor` сервисному аккаунту CI/CD, который был скомпрометирован.  
*Последствия:* Злоумышленник получил права на запись во все ресурсы проекта, развернул майнер.  
*Вывод:* Нужно было использовать `roles/cloudbuild.builds.editor` с ограниченными правами.

**Чек-лист:**
- [ ] Нет пользователей с примитивными ролями (owner/editor/viewer) на уровне организации/папки
- [ ] Сервисные аккаунты имеют минимально необходимые права
- [ ] Используются условия IAM для ограничений по времени/IP
- [ ] Включено логирование административных действий

### **Безопасность Istio (Микросегментация на основе HTTP/S)**
**Цель:** Zero-Trust взаимодействие между сервисами  
**Требования:**
- Mutual TLS (mTLS) для всего межсервисного трафика
- Политики авторизации "запрещено по умолчанию"
- Проверка идентификации workload'ов

**Рекомендации:**
- Режим STRICT для mTLS
- Изоляция namespace'ов
- Использование JWT-токенов для детального контроля

**Пример нарушения:**  
*Случай (2022):* Отсутствие AuthorizationPolicy позволило перемещение с фронтенда на БД.  
*Последствия:* Утечка 450K записей клиентов.  
*Вывод:* Нужно было политику "DENY all" с явными разрешениями.

**Чек-лист:**
- [ ] mTLS в режиме STRICT для всего кластера
- [ ] Политика "запрещено по умолчанию"
- [ ] Регулярное сканирование на ошибочные конфигурации

## **2. Защита VPC для приватных сервисов**

### **VPC Service Controls**
**Цель:** Предотвращение утечки данных  
**Требования:**
- Определение сервисных периметров
- Настройка уровней доступа
- Контекстно-зависимый доступ

**Рекомендации:**
- Многоуровневые периметры
- Регулярное тестирование
- Логирование нарушений границ

**Пример нарушения:**  
*Случай (2022):* Отсутствие периметра позволило копирование из приватного GCS в публичный бакет.  
*Последствия:* Утечка 2TB конфиденциальных данных.  
*Вывод:* Нужно было настроить VPC SC с правильными уровнями доступа.

**Чек-лист:**
- [ ] Определены периметры для важных проектов
- [ ] Нет ресурсов в обход периметров
- [ ] Настроены алерты на нарушения

## **3. Защита публичных приложений**

### **Cloud Armor**
**Цель:** Защита приложений  
**Требования:**
- WAF-правила
- Ограничение запросов
- Защита от ботов

**Рекомендации:**
- Правила OWASP
- Настройка кастомных правил
- Регулярные обновления

**Пример нарушения:**  
*Случай (2022):* SQL-инъекция через незащищенный endpoint.  
*Последствия:* Компрометация БД.  
*Вывод:* Нужно было включить WAF-правила.

**Чек-лист:**
- [ ] Включены правила OWASP
- [ ] Настроено ограничение запросов
- [ ] Включено логирование

## **Итоговый чек-лист безопасности**

| Уровень                | Ключевые проверки                         | Соответствие |
|------------------------|------------------------------------------|--------------|
| **IAM**                | Нет примитивных ролей, включена MFA      | ☐            |
| **Cloud Armor**        | Правила OWASP, ограничение запросов      | ☐            |
| **VPC SC**             | Определены периметры, нет обходов        | ☐            |

**Рекомендации по внедрению:**
1. Начните с организационных политик и IAM
2. Реализуйте сегментацию сети (VPC SC, firewall'ы)
3. Защитите workload'ы (GKE, Istio)
4. Защитите публичные приложения (LB, Armor)
5. Включите полное логирование и мониторинг

**Поддержка:**
- Ежемесячный пересмотр политик
- Квартальные пентесты
- Постоянный мониторинг соответствия
- Автоматическое исправление где возможно

Такой подход обеспечивает многоуровневую защиту, значительно усложняя атаки и обеспечивая полную прозрачность безопасности.